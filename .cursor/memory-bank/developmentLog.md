# История разработки MoonBit

Этот документ содержит историю разработки проекта MoonBit с описанием ключевых этапов, решений и изменений.

## Май 2023

### Неделя 1: Проектирование и базовая инфраструктура

- **01.05.2023**: Определение концепции проекта и основных требований
- **02.05.2023**: Создание документации по архитектуре и структуре проекта
- **03.05.2023**: Настройка окружения разработки и базовой структуры проекта
- **04.05.2023**: Настройка линтеров, форматтеров и pre-commit хуков
- **05.05.2023**: Создание первого прототипа API и структуры базы данных

### Неделя 2: Реализация бэкенд-сервисов

- **08.05.2023**: Разработка BitcoinService для получения данных о цене биткоина
- **09.05.2023**: Разработка механизма кэширования данных для оптимизации запросов
- **10.05.2023**: Реализация MoonService для работы с данными о фазах луны
- **11.05.2023**: Создание AstroService для астрологических данных
- **12.05.2023**: Разработка EventsService для отслеживания событий

### Неделя 3: API и интеграция

- **15.05.2023**: Реализация API маршрутов и контроллеров
- **16.05.2023**: Разработка DataSyncService для координации синхронизации данных
- **17.05.2023**: Внедрение системы логирования и обработки ошибок
- **18.05.2023**: Тестирование API и исправление ошибок
- **19.05.2023**: Оптимизация производительности и рефакторинг кода

### Неделя 4: Клиентская часть

- **22.05.2023**: Настройка клиентского приложения с React и Vite
- **23.05.2023**: Разработка базовых компонентов UI
- **24.05.2023**: Реализация компонентов для отображения данных о биткоине
- **25.05.2023**: Создание компонентов для визуализации фаз луны
- **26.05.2023**: Интеграция клиента с API

## Июнь 2023

### Неделя 1: Улучшение UI/UX

- **29.05.2023**: Разработка темной/светлой темы
- **30.05.2023**: Создание графиков для визуализации данных
- **31.05.2023**: Реализация адаптивного дизайна
- **01.06.2023**: Улучшение UX при загрузке данных
- **02.06.2023**: Добавление анимаций и переходов

### Неделя 2: Тестирование и оптимизация

- **05.06.2023**: Написание модульных тестов для сервисов
- **06.06.2023**: Написание интеграционных тестов
- **07.06.2023**: Настройка CI/CD
- **08.06.2023**: Оптимизация производительности
- **09.06.2023**: Рефакторинг и улучшение качества кода

## Май 2024

### Восстановление и обновление проекта

- **18.05.2024**: Обнаружено, что некоторые файлы были удалены. Начат процесс восстановления
- **19.05.2024**: Восстановлены сервисы BitcoinService, MoonService, AstroService и EventsService
- **19.05.2024**: Восстановлен сервис DataSyncService и утилита логирования
- **19.05.2024**: Обновлена документация и структура Memory Bank
- **19.05.2024**: Добавлены архитектурные принципы KISS, DRY и DDD
- **20.05.2024**: Внедрены отдельные контроллеры для разгрузки маршрутов API
- **20.05.2024**: Обновлена документация архитектуры с учетом изменений в структуре проекта

## Ключевые технические решения

### Кэширование данных

- **Проблема**: Частые запросы к внешним API приводили к достижению лимитов
- **Решение**: Разработан механизм файлового кэширования с гибкими TTL
- **Результат**: Снижение количества запросов к внешним API на 80%

### Обработка недоступности API

- **Проблема**: Внешние API иногда недоступны, что приводило к ошибкам
- **Решение**: Реализована стратегия возврата кэшированных данных при проблемах с API
- **Результат**: Повышение стабильности приложения до 99.5%

### Оптимизация React-компонентов

- **Проблема**: Медленный рендеринг при изменении данных
- **Решение**: Внедрение мемоизации и оптимизация управления состоянием
- **Результат**: Улучшение производительности клиентской части на 40%

### Разделение ответственности

- **Проблема**: Сложность развития и поддержки монолитного кода
- **Решение**: Внедрение принципов DDD и разделение на чёткие модули
- **Результат**: Упрощение поддержки и развития отдельных компонентов

### Разделение маршрутов и контроллеров

- **Проблема**: Перегруженные маршруты API с бизнес-логикой и обработкой запросов
- **Решение**: Выделение контроллеров в отдельные классы с четкой ответственностью
- **Результат**: Улучшение структуры кода, упрощение поддержки и тестирования API

## Извлеченные уроки

### Технические уроки

1. **Раннее внедрение кэширования** сэкономило много времени на оптимизации
2. **Строгое разделение ответственности** упростило разработку и тестирование
3. **Автоматизация процессов** (CI/CD, линтинг) повысила качество кода

### Процессные уроки

1. **Документирование архитектурных решений** помогает поддерживать согласованность
2. **Регулярный рефакторинг** предотвращает накопление технического долга
3. **Тщательное тестирование интеграций** экономит время на отладке

# Журнал разработки

## 2024-05-28: Исправление ошибок запуска Docker-контейнеров

### Проблемы и решения

#### 1. Ошибка сервера: Отсутствующие файлы маршрутов

**Проблема:**
```
Error [ERR_MODULE_NOT_FOUND]: Cannot find module '/app/src/routes/events.js' imported from /app/src/index.js
```

**Причина:** Файлы маршрутов не копировались корректно в Docker-контейнер.

**Решение:**
- Обновлен Dockerfile для сервера с изменением порядка копирования файлов
- Добавлена проверка наличия файлов маршрутов в процессе сборки

#### 2. Ошибка клиента: Отсутствующая библиотека astronomia

**Проблема:**
```
Error: The following dependencies are imported but could not be resolved:
  astronomia (imported by /app/src/services/astroEvents.js)
```

**Причина:** Пакет astronomia не был установлен в Docker-контейнере клиента.

**Решение:**
- Добавлен пакет astronomia в package.json клиента
- Обновлен Dockerfile для явной установки пакета

### Выводы и рекомендации

1. **Мониторинг логов:**
   - Необходимо активно мониторить логи при запуске контейнеров
   - Оперативно исправлять ошибки, связанные с отсутствующими зависимостями

2. **Тестирование Docker-сборок:**
   - Тестировать сборку Docker-контейнеров перед коммитом изменений
   - Проверять корректную работу приложения в контейнерах

3. **Управление зависимостями:**
   - Синхронизировать зависимости между package.json и Docker-образами
   - Использовать lock-файлы для фиксации версий зависимостей

## 2024-05-27: Переход от CommonJS к ES модулям

### Проблемы и решения

**Проблема:** Смешивание CommonJS и ES модулей в серверной части приложения.

**Решение:**
- Конвертированы все файлы с CommonJS синтаксисом (require/module.exports) на ES модули (import/export)
- Добавлено поле "type": "module" в package.json сервера
- Исправлены пути импорта с добавлением расширения .js

### Уроки

1. Последовательность в использовании модульной системы критически важна
2. При переходе на ES модули необходимо добавлять расширения файлов в пути импорта
3. Регистр имен файлов имеет значение и может вызывать проблемы на разных платформах

## 2024-05-29: Создание сервиса для работы с реальными данными о фазах Луны

### Изменения и улучшения

**Проблема:** Использование моковых данных для астрономических событий не позволяло иметь реальные данные о фазах Луны.

**Решение:**
- Создан `AstroService.js` - специализированный сервис для работы с астрономическими данными
- Реализованы методы для получения как исторических, так и предстоящих фаз Луны
- Использован пакет `astronomia` для точных астрономических расчетов
- Обновлен `astroEvents.js` для использования нового сервиса

**Результат:**
- Возможность получать реальные данные о новолуниях и полнолуниях
- Подготовка к интеграции фаз Луны с графиком цены биткоина
- Возможность отображения предстоящих фаз Луны в виджете событий

### Соглашения по именованию

**Проблема:** Отсутствие четких соглашений по именованию файлов и компонентов.

**Решение:**
- Определены стандарты именования: PascalCase для компонентов и классов, camelCase для функций и утилит
- Создан документ `namingConventions.md` с подробными правилами
- Обновлен `activeContext.md` с информацией о соглашениях

**Результат:**
- Повышение согласованности кодовой базы
- Облегчение навигации по проекту
- Упрощение ревью кода

### Уроки

1. Использование специализированных библиотек (astronomia) позволяет быстро реализовать сложные расчеты
2. Четкие соглашения по именованию значительно улучшают структуру и поддерживаемость проекта
3. Следование принципу разделения ответственности делает код более модульным и легко тестируемым
