# Технический контекст MoonBit

## Серверная часть

### Стек технологий

- **Язык программирования**: TypeScript (Node.js)
- **Веб-фреймворк**: Express.js
- **Логирование**: Winston
- **Валидация данных**: Zod
- **Обработка HTTP-запросов**: Axios
- **Документация API**: TSDoc + HTML-документация
- **IoC-контейнер**: InversifyJS

### Структура серверной части

- **/src/controllers/** - обработчики запросов
- **/src/routes/** - маршруты API
- **/src/services/** - бизнес-логика и взаимодействие с внешними API
- **/src/utils/** - утилиты и вспомогательные функции
- **/src/data/** - локальное хранение данных и кэш (включая интеграцию с Redis)
- **/src/types/** - определения типов TypeScript
- **/src/config/** - конфигурационные файлы
- **/src/inversify.config.ts** - конфигурация IoC-контейнера
- **/docs/** - документация API
- **/logs/** - логи приложения
- **/**tests**/** - тесты
- **/**mocks**/** - моки для тестирования

### Внешние API и интеграции

1. **CoinGecko API**

   - Используется для получения данных о цене биткоина
   - Имеет лимит запросов (до 50 запросов в минуту для бесплатного плана)
   - Endpoint: https://api.coingecko.com/api/v3/

2. **FarmSense API**
   - Используется для получения данных о фазах луны
   - Endpoint: https://api.farmsense.net/v1/moonphases/

### Механизмы кэширования

- **Redis**: Внедрен для более эффективного кэширования данных от внешних API.
- Файловый кэш (устаревает, будет заменен Redis)
- Стратегия кэширования: TTL (Time-To-Live) с разными значениями в зависимости от типа данных:
  - Цена биткоина: 15 минут
  - Исторические данные: 24 часа
  - Данные о луне: 1 час
  - Астрологические данные: 6 часов
  - События: 30 минут

### Синхронизация данных

- Сервис DataSyncService координирует обновление всех данных
- Работает в фоновом режиме через интервалы
- Имеет механизмы повторных попыток при ошибках
- Записывает результаты синхронизации в логи

## Клиентская часть

### Стек технологий

- **Библиотека UI**: React.js
- **Сборка**: Vite
- **Стили**: TailwindCSS
- **Графики**: Chart.js
- **Управление состоянием**: React Context API + useState/useReducer
- **HTTP-клиент**: Axios
- **Форматирование дат**: Day.js

### Структура клиентской части

- **/src/components/** - компоненты React
- **/src/hooks/** - пользовательские хуки
- **/src/services/** - сервисы для работы с API (настроено проксирование через Vite)
- **/src/utils/** - вспомогательные функции
- **/src/assets/** - статические ресурсы
- **/public/** - публичные файлы
- **/**tests**/** - тесты
- **/**mocks**/** - моки для тестирования

### Особенности реализации

- Адаптивный дизайн (mobile-first)
- Темная и светлая темы с автоматическим переключением в зависимости от фазы луны
- Оптимизированные ререндеры компонентов через мемоизацию
- Механизм перехвата и обработки ошибок (ErrorBoundary)
- Отладочная панель в режиме разработки (DevPanel)

## Инфраструктура и деплой

### Разработка

- **Контроль версий**: Git (GitHub)
- **Линтинг**: ESLint с Airbnb style guide
- **Форматирование**: Prettier
- **Pre-commit хуки**: Husky + lint-staged
- **Тестирование**: Jest + React Testing Library (на сервере), Vitest + React Testing Library (на клиенте), Playwright (E2E)
- **Контейнеризация локальной разработки**: Docker Compose

### Деплой

- **Контейнеризация**: Docker
- **Непрерывная интеграция**: GitHub Actions
- **Хостинг**: Любой провайдер, поддерживающий Docker

## Требования и ограничения

### Производительность

- Время первой загрузки: < 2 секунды
- Время отклика API: < 300 мс
- Размер бандла: < 500 KB (gzipped)

### Совместимость

- Поддержка последних 2 версий основных браузеров
- Мобильные устройства: iOS 13+, Android 8+

### Безопасность

- Отсутствие хранения чувствительных данных
- Защита от основных веб-уязвимостей (XSS, CSRF)
- Валидация всех входных данных

### Масштабируемость

- Горизонтальное масштабирование через Docker
- Кэширование для снижения нагрузки на внешние API (через Redis)

## Technologies used

### Backend

- **Node.js**: Основная платформа для серверной части
- **TypeScript**: Язык программирования на сервере, обеспечивает статическую типизацию
- **Express.js**: Web-фреймворк для создания API
- **InversifyJS**: IoC-контейнер для управления зависимостями

### Frontend

- **React**: Библиотека для создания пользовательского интерфейса
- **Tailwind CSS**: Utility-first CSS фреймворк для стилизации
- **JavaScript/TypeScript**: Язык программирования для клиентской части
- **Vite**: Сборщик для клиентской части, используется для локальной разработки и проксирования

### Хранение данных

- **Redis**: Для эффективного кэширования данных на сервере
- Файловое кэширование (устаревает)

### API интеграции

- **CoinGecko API**: Данные о биткоине (текущие цены, история)
- **FarmSense API**: Данные о фазах луны
- **Bybit API** (отложено): Расширенные данные о криптовалютах

## Development setup

### Требования

- Node.js 18+
- npm/yarn
- Docker Desktop

### Запуск разработки с Docker Compose

```bash
# Запустить все сервисы (клиент, сервер, redis)
cd /path/to/moonbit/root
docker-compose up -d --build

# Остановка сервисов
docker-compose down

# Просмотр логов сервера
docker logs moonbit-server

# Просмотр логов клиента
docker logs moonbit-client
```

### Запуск разработки без Docker (устаревает)

```bash
# Сервер
cd bitcoin-moon/server
npm install
npm run dev

# Клиент
cd bitcoin-moon/client
npm install
npm run dev
```

## Technical constraints

### Текущие ограничения

1. **Простота перед оптимизацией**: Приоритет на функциональность и чистоту кода
2. **Минималистичный стек**: Избегаем преждевременного усложнения архитектуры
3. **Заглушки в TypeScript сервисах**: Необходима полная реализация логики взаимодействия с внешними API.
4. **Адаптация тестов**: Существующие тесты нужно адаптировать к TypeScript коду.

### Отложенные оптимизации

1. **Полная интеграция Redis**: Внедрение во все сервисы для кэширования.
2. **Сложные интеграции с API**: Будут добавлены после стабилизации основной функциональности
3. **WebSocket**: Будет использован для real-time данных позже

## Dependencies

### Серверные зависимости

- express
- axios
- winston (логирование)
- dotenv (управление конфигурацией)
- **typescript**
- **ts-node**
- **inversify**
- **reflect-metadata**
- **ioredis**
- **@types/express**
- **@types/node**
- **@types/winston**
- **@types/ioredis**

### Клиентские зависимости

- react
- react-dom
- tailwindcss
- axios
- chart.js (для графиков)
- **@types/react**
- **@types/react-dom**
